<!DOCTYPE html>
<html>
<head>
	<title>ICS 414 Calendar Project</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css">
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.js"></script>
	<link rel="stylesheet" href="./style.css">
	<script type="text/javascript">
// object of user inputs
var userInputs = {
	title: "",
	startHour: "8",
	startMinute: "00",
	startAMPM: "AM",
	finishHour: "12",
	finishMinute: "00",
	finishAMPM: "PM",
	dateMonth: "",
	dateDay: "",
	dateYear: "",
	location: "",
  latitude: "",
  longitude: "",
	description: ""
};
// array of month names
var monthNames = [
	"January",
	"February",
	"March",
	"April",
	"May",
	"June",
	"July",
	"August",
	"September",
	"October",
	"November",
	"December"
];
// array of container names
var containerNames = [
	"menu",
	"title",
	"startAndFinishTimes",
	"date",
	"location",
	"geo",
  "description"
];

// source: https://stackoverflow.com/questions/45831191/generate-and-download-file-from-js/45831280#45831280
// known issue: does not work on IE, could be solved by generating the file on a server instead of in JavaScript
function download(filename, text) {
	var element = document.createElement('a');
	element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
	element.setAttribute('download', filename);

	element.style.display = 'none';
	document.body.appendChild(element);

	element.click();

	document.body.removeChild(element);
}
// source: https://stackoverflow.com/questions/105034/create-guid-uuid-in-javascript/2117523#2117523
function uuidv4() {
	return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
		var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
		return v.toString(16);
	});
}
// function to generate formated timestamps from date object
function formatTimestamp(date) {
	// https://tools.ietf.org/html/rfc5545#section-3.3.5
	// FORM #2: DATE WITH UTC TIME
	// January 19, 1998, at 0700 UTC:
	// 19980119T070000Z

	// getUTCFullYear() returns YYYY
	var year = date.getUTCFullYear();
	// getUTCMonth() returns 0-11, we need 01-12
	var month = ((date.getUTCMonth() + 1) < 10 ? "0" : "") + (date.getUTCMonth() + 1);
	// getUTCDate() returns 1-31, we need 01-31
	var day = (date.getUTCDate() < 10 ? "0" : "") + date.getUTCDate();
	// getUTCHours() returns 0-23, we need 00-23
	var hours = (date.getUTCHours() < 10 ? "0" : "") + date.getUTCHours();
	// getUTCMinutes() returns 0-59, we need 00-59
	var minutes = (date.getUTCMinutes() < 10 ? "0" : "") + date.getUTCMinutes();
	// getUTCSeconds() returns 0-59, we need 00-59
	var seconds = (date.getUTCSeconds() < 10 ? "0" : "") + date.getUTCSeconds();

	return year + month + day + "T" + hours + minutes + seconds + "Z";
}
// function to add hour options to a select input
function generateHourOptions(elementId) {
	// get the select element to add options to
	var selectElement = document.getElementById(elementId);

	// create options for 12, 1, 2, ... 11
	for (var i = 0; i < 12; i++) {
		// create new option element
		var optionElement = document.createElement('option');
		// we need 0 to be 12
		optionElement.value = (i === 0 ? "12" : i);
		optionElement.innerHTML = (i === 0 ? "12" : i);
		// append new option element to the select element
		selectElement.appendChild(optionElement);
	}
}
// function to add minute options to a select input
function generateMinuteOptions(elementId) {
	// get the select element to add options to
	var selectElement = document.getElementById(elementId);

	// create options for 0, 1, 2, ... 59
	for (var i = 0; i < 60; i++) {
		// create new option element
		var optionElement = document.createElement('option');
		// we need 00-59
		optionElement.value = (i < 10 ? "0" : "") + i;
		optionElement.innerHTML = (i < 10 ? "0" : "") + i;
		// append new option element to the select element
		selectElement.appendChild(optionElement);
	}
}
// function to add month options to a select input
function generateMonthOptions(elementId) {
	// get the select element to add options to
	var selectElement = document.getElementById(elementId);

	// create options for each month, monthNames declared globally
	monthNames.forEach(function(month, index) {
		// create new option element
		var optionElement = document.createElement('option');
		optionElement.value = index;
		optionElement.innerHTML = month;
		// append new option element to the select element
		selectElement.appendChild(optionElement);
	});
}
// function to add day options to a select input
function generateDayOptions(elementId) {
	// get the select element to add options to
	var selectElement = document.getElementById(elementId);

	// create options for 1, 2, ... 31
	for (var i = 1; i <= 31; i++) {
		// create new option element
		var optionElement = document.createElement('option');
		optionElement.value = i;
		optionElement.innerHTML = i;
		// append new option element to the select element
		selectElement.appendChild(optionElement);
	}
}
// function to add year options to a select input
function generateYearOptions(elementId) {
	// get the select element to add options to
	var selectElement = document.getElementById(elementId);
	// set to current time
	var currentTime = new Date();

	// create options for YYYY, YYYY + 1, ... YYYY + 9
	for (var i = 0; i < 10; i++) {
		// create new option element
		var optionElement = document.createElement('option');
		optionElement.value = (currentTime.getUTCFullYear() + i);
		optionElement.innerHTML = (currentTime.getUTCFullYear() + i);
		// append new option element to the select element
		selectElement.appendChild(optionElement);
	}
}

// function to hide all containers
function hideAllContainers() {
	// loop through containerNames
	containerNames.forEach(function(container) {
		// set display CSS property to none
		document.getElementById(container + "Container").style.display = 'none';
	});
}
// function to set input field values to the corresponding value stored in the userInputs object
function setInputFieldValues() {
	// loop through userInputs
	Object.keys(userInputs).forEach(function(key) {
		// set the corresponding input field to the value stored in the userInputs object
		document.getElementById(key).value = userInputs[key];
	});
}
// function to cancel any changes and return to main container
function cancelEdit() {
	// reset input field values
	setInputFieldValues();
	// go back to main container
	window.history.go(-1);
}
// function to save any changes and return to main container
function saveEdit() {
	// loop through userInputs
	Object.keys(userInputs).forEach(function(key) {
	  // set the value stored in the userInputs object to the corresponding input field value
    userInputs[key] = document.getElementById(key).value;
	});

	// go back to main container
	window.history.go(-1);
}

function fixLatitude() {
    if (document.getElementById("latitude").value > 90) {
      document.getElementById("latitude").value = 90;
    }
    else if (document.getElementById("latitude").value < -90) {
      document.getElementById("latitude").value = -90;
    }
    document.getElementById("latitude").value = parseFloat(document.getElementById("latitude").value).toFixed(6);
}

function fixLongitude() {
    if(document.getElementById("longitude").value > 180) {
      document.getElementById("longitude").value = 180;
    }
    else if(document.getElementById("longitude").value < -180) {
      document.getElementById("longitude").value = -180;
    }
    document.getElementById("longitude").value = parseFloat(document.getElementById("longitude").value).toFixed(6);
}

window.onload = function() {
	// generate options for select inputs
	generateHourOptions("startHour");
	generateMinuteOptions("startMinute");
	generateHourOptions("finishHour");
	generateMinuteOptions("finishMinute");
	generateMonthOptions("dateMonth");
	generateDayOptions("dateDay");
	generateYearOptions("dateYear");
	// get the current time
	var currentTime = new Date();
	// set the default date to today
	userInputs["dateMonth"] = currentTime.getMonth();
	userInputs["dateDay"] = currentTime.getDate();
	userInputs["dateYear"] = currentTime.getFullYear();
	// set default input field values
	setInputFieldValues();

	document.getElementById("download-button").addEventListener("click", function() {
		// format user inputs
		// need hour in 0-23 integer, have 12, 1, 2 ... 11 string and AM/PM
		var startHour = (userInputs["startHour"] == "12" ? 0 : parseInt(userInputs["startHour"], 10)) + (userInputs["startAMPM"] == "PM" ? 12 : 0);
		var finishHour = (userInputs["finishHour"] == "12" ? 0 : parseInt(userInputs["finishHour"], 10)) + (userInputs["finishAMPM"] == "PM" ? 12 : 0);
		// need month in 0-59 integer, have 00-59 string
		var startMinute = parseInt(userInputs["startMinute"], 10);
		var finishMinute = parseInt(userInputs["finishMinute"], 10);
		// need month in 0-11 integer, have 0-11 string
		var dateMonth = parseInt(userInputs["dateMonth"], 10);
		// need day in 1-31 integer, have 1-31 string
		var dateDay = parseInt(userInputs["dateDay"], 10);
		// need year in YYYY integer, have YYYY string
		var dateYear = parseInt(userInputs["dateYear"], 10);
		// set to current time
		var dtstamp = new Date();
		// set to user input
		var dtstart = new Date(dateYear, dateMonth, dateDay, startHour, startMinute, 0, 0);
		var dtend = new Date(dateYear, dateMonth, dateDay, finishHour, finishMinute, 0, 0);
    var fLatitude =  (parseFloat(userInputs["latitude"])).toFixed(6);
    var fLongitude = (parseFloat(userInputs["longitude"])).toFixed(6);
		var filename = "event.ics";
		var text = "";
		text += "BEGIN:VCALENDAR\r\n";
		text += "VERSION:2.0\r\n";
		text += "PRODID:-//University of Hawaii//ICS 414 Calendar Project//EN\r\n";
		text += "BEGIN:VEVENT\r\n"; // https://tools.ietf.org/html/rfc5545#section-3.6.1
		text += "UID:" + uuidv4() + "\r\n"; // required
		text += "DTSTAMP:" + formatTimestamp(dtstamp) + "\r\n"; // required
		text += "DTSTART:" + formatTimestamp(dtstart) + "\r\n"; // required if METHOD not specified
		text += "DTEND:" + formatTimestamp(dtend) + "\r\n"; // optional
    text += "GEO:" + fLatitude + ";" + fLongitude + "\r\n";


		// only include summary if title isn't empty
		if (userInputs["title"].length > 0) {
			text += "SUMMARY:" + userInputs["title"] + "\r\n"; // optional; to do: ensure line length meets RFC requirement
		}
		// only include location if location isn't empty
		if (userInputs["location"].length > 0) {
			text += "LOCATION:" + userInputs["location"] + "\r\n"; // optional; to do: ensure line length meets RFC requirement
		}

		// only include description if description isn't empty
		if (userInputs["description"].length > 0) {
			text += "DESCRIPTION:" + userInputs["description"] + "\r\n"; // optional; to do: ensure line length meets RFC requirement
		}

		// testing Classification (3.8.1.3)
		text += "CLASS:PUBLIC\r\n";
		//text += "CLASS:PRIVATE\r\n";
		//text += "CLASS:CONFIDENTIAL\r\n";

		// testing Priority (3.8.1.9), integer 0-9, 0 undefined, 1 highest, 9 lowest
		text += "PRIORITY:0\r\n";
		//text += "PRIORITY:1\r\n";
		//text += "PRIORITY:9\r\n";

		text += "END:VEVENT\r\n";
		text += "END:VCALENDAR\r\n";

		if (dtstart > dtend) {
			alert("Error: Start time after finish time");
		}
    else {
			download(filename, text);
		}
	}, false);
}
window.onhashchange = function() {
	// if the hash length is greater than zero, show the corresponding container
	if (location.hash.length > 0) {
		// get the part following the hash sign
		hash = location.hash.split("#")[1];

		// show the container if it exists, otherwise go back
		if (containerNames.indexOf(hash) >= 0) {
			hideAllContainers();
			document.getElementById(hash + "Container").style.display = 'block';
		} else {
			window.history.go(-1);
		}
	// otherwise show menu container
	} else {
		hideAllContainers();
		document.getElementById("menuContainer").style.display = 'block';
	}
}
	</script>
</head>
<body class="ui container">
	<div id="mainContainer" class="ui centered segment">
		<h1 id="header" class="ui center aligned header">ICS414 Calendaring System</h1>
		<div id="menuContainer" class="ui container">
			<a href="#title">Set Title</a>
			<br />
			<a href="#startAndFinishTimes">Set Start and Finish Times</a>
			<br />
			<a href="#date">Set Date</a>
			<br />
			<a href="#location">Set Location</a>
			<br />
      <a href="#geo">Set Graphical Location</a>
      <br />
			<a href="#description">Set Description</a>
			<br />
			<button class="fluid ui blue huge button" id="download-button">Download Event .ics File</button>
		</div>
		<div id="titleContainer" class="ui form segment" style="display: none;">
			<div class="field">
				<label for="title">Title</label>
				<input type="text" id="title" name="title" placeholder="Title (optional)" />
			</div>
			<div class="fluid ui buttons">
				<button class="ui button" onclick="cancelEdit()">Cancel</button>
				<button class="ui positive button" onclick="saveEdit()">Save</button>
			</div>
		</div>
		<div id="startAndFinishTimesContainer" class="ui form segment" style="display: none;">
			<div class="field">
				<label for="startHour">Start</label>
				<div class="fields">
					<div class="field">
						<select id="startHour" name="startHour"></select>
					</div>
					<div class="field">
						<select id="startMinute" name="startMinute"></select>
					</div>
					<div class="field">
						<select id="startAMPM" name="startAMPM">
							<option value="AM" selected>AM</option>
							<option value="PM">PM</option>
						</select>
					</div>
				</div>
			</div>
			<div class="field">
				<label for="finishHour">Finish</label>
				<div class="fields">
					<div class="field">
						<select id="finishHour" name="finishHour"></select>
					</div>
					<div class="field">
						<select id="finishMinute" name="finishMinute"></select>
					</div>
					<div class="field">
						<select id="finishAMPM" name="finishAMPM">
							<option value="AM" selected>AM</option>
							<option value="PM">PM</option>
						</select>
					</div>
				</div>
			</div>
			<div class="fluid ui buttons">
				<button class="ui button" onclick="cancelEdit()">Cancel</button>
				<button class="ui positive button" onclick="saveEdit()">Save</button>
			</div>
		</div>
		<div id="dateContainer" class="ui form segment" style="display: none;">
			<div class="field">
				<label for="dateMonth">Date</label>
				<div class="fields">
					<div class="field">
						<select id="dateMonth" name="dateMonth"></select>
					</div>
					<div class="field">
						<select id="dateDay" name="dateDay"></select>
					</div>
					<div class="field">
						<select id="dateYear" name="dateYear"></select>
					</div>
				</div>
			</div>
			<div class="fluid ui buttons">
				<button class="ui button" onclick="cancelEdit()">Cancel</button>
				<button class="ui positive button" onclick="saveEdit()">Save</button>
			</div>
		</div>
		<div id="locationContainer" class="ui form segment" style="display: none;">
			<div class="field">
				<label for="location">Location</label>
				<input type="text" id="location" name="location" placeholder="Location (optional)" />
			</div>
			<div class="fluid ui buttons">
				<button class="ui button" onclick="cancelEdit()">Cancel</button>
				<button class="ui positive button" onclick="saveEdit()">Save</button>
			</div>
		</div>
    <div id="geoContainer" class="ui form segment" style="display: none;">
      <div class="field">
        <label for="latitude">Latitude</label>
        <input type="number" id="latitude" max = "90" min="-90" value="0" step="0.000001" onfocusout="fixLatitude()">
      </div>
      <div class="field">
        <label for="longitude">Longitude</label>
          <input type="number" id="longitude" max = "180" min="-180" value="0" step="0.000001" onfocusout="fixLongitude()">
      </div>
      <div class="fluid ui buttons">
        <button class="ui button" onclick="cancelEdit()">Cancel</button>
        <button class="ui positive button" onclick="saveEdit()">Save</button>
      </div>
    </div>
		<div id="descriptionContainer" class="ui form segment" style="display: none;">
			<div class="field">
				<label for="description">Description</label>
				<textarea id="description" name="description" placeholder="Description (optional)" ></textarea>
			</div>
			<div class="fluid ui buttons">
				<button class="ui button" onclick="cancelEdit()">Cancel</button>
				<button class="ui positive button" onclick="saveEdit()">Save</button>
			</div>
		</div>
	</div>
</body>
</html>


